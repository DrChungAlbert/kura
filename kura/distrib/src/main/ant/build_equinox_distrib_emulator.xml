<!-- Copyright (c) 2011, 2014 Eurotech and/or its affiliates All rights reserved. 
	This program and the accompanying materials are made available under the 
	terms of the Eclipse Public License v1.0 which accompanies this distribution, 
	and is available at http://www.eclipse.org/legal/epl-v10.html Contributors: 
	Eurotech -->
<project name="build_equinox_distrib_emulator" default="dist-emulator"
	basedir="../../../">

	<target name="dist-emulator">

		<property name="build.output.name" value="kura_${project.version}_${build.name}" />

		<echo message="Building Kura Distribution for ${build.output.name}..." />

		<copy
			file="./../org.eclipse.kura.emulator/src/main/resources/kura.properties"
			tofile="${project.build.directory}/${build.output.name}/kura.properties" />
		<propertyfile
			file="${project.build.directory}/${build.output.name}/kura.properties">
			<entry key="kura.version" value="KURA_${kura.version}" />
			<entry key="kura.home" value="${kura.install.dir}/kura/kura" />
			<entry key="kura.plugins" value="${kura.install.dir}/kura/kura/plugins" />
			<entry key="kura.packages" value="${kura.install.dir}/kura/kura/packages" />
			<entry key="version" value="${kura.version}" />
			<entry key="build.version" value="${buildNumber}" />
			<entry key="build.number" value="${build.name}-${buildNumber}" />
		</propertyfile>
		<replace
			file="${project.build.directory}/${build.output.name}/kura.properties"
			token="{kura.install.dir}" value="${kura.install.dir}" />
		<replace
			file="${project.build.directory}/${build.output.name}/kura.properties"
			token="{kura.symlink}" value="${kura.symlink}" />


		<condition property="kura.osgi.repo"
			value="../target-definition/equinox_3.8.1/repository">
			<or>
				<not>
					<isset property="kura.osgi" />
				</not>
				<equals arg1="${kura.osgi}" arg2="equinox" />
			</or>
		</condition>

		<copy file="src/main/resources/${build.name}/snapshot_0.xml"
			tofile="${project.build.directory}/${build.output.name}/snapshot_0.xml" />
		<copy file="src/main/osgi/equinox_3.8.1/configuration/config-emulator.ini"
			tofile="${project.build.directory}/${build.output.name}/config.ini" />
	
        <!-- Copy jdk.dio files -->
        <copy file="src/main/resources/${build.name}/jdk.dio.properties"
              tofile="${project.build.directory}/${build.output.name}/jdk.dio.properties" />
        <copy file="src/main/resources/common/jdk.dio.policy"
              tofile="${project.build.directory}/${build.output.name}/jdk.dio.policy" />
		
		<!-- Populate config.ini with correct versions -->
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{kura.build.version}" value="${kura.build.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.api.version}" value="${org.eclipse.kura.api.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.deployment.agent.version}" value="${org.eclipse.kura.deployment.agent.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.version}" value="${org.eclipse.kura.core.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.cloud.version}" value="${org.eclipse.kura.core.cloud.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.comm.version}" value="${org.eclipse.kura.core.comm.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.configuration.version}" value="${org.eclipse.kura.core.configuration.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.crypto.version}" value="${org.eclipse.kura.core.crypto.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.core.net.version}" value="${org.eclipse.kura.core.net.version}" />
		<replace file="${project.build.directory}/${build.output.name}/config.ini"
			token="{org.eclipse.kura.emulator.version}" value="${org.eclipse.kura.emulator.version}" />

		<available
			file="${project.build.directory}/plugins/org.eclipse.kura.web_${org.eclipse.kura.web.version}.jar"
			property="web.jar.present" />
		<antcall target="web-config" />

		<!-- Create the Kura start scripts -->
		<echo
			file="${project.build.directory}/${build.output.name}/start_kura_background.sh"
			append="false">#!/bin/sh

			# Kura should be installed to the ${kura.install.dir} directory.
			export
			PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin:/opt/jvm/bin:/usr/java/bin

			DIR=$(cd $(dirname $0)/..; pwd)
			cd $DIR

			# set up the configuration area
			mkdir -p /tmp/.kura/configuration
			cp ${DIR}/kura/config.ini /tmp/.kura/configuration/

			nohup java -Xms${kura.mem.size} -Xmx${kura.mem.size}
			-XX:MaxPermSize=${kura.mem.size} -Dkura.os.version=${kura.os.version}
			\
			-Dorg.osgi.service.http.port=8080 \
			-Dosgi.clean=true \
			-Dosgi.noShutdown=true \
			-Declipse.ignoreApp=true \
			-Dorg.eclipse.kura.mode=emulator \
			-Dkura.configuration=file:${DIR}/kura/kura.properties \
			-Ddpa.configuration=${DIR}/kura/dpa.properties \
			-Dlog4j.configuration=file:${DIR}/kura/log4j.properties \
			-Dkura.arch=${kura.arch} \
			-Dtarget.device=${target.device} \
			-Dkura.home=${DIR}/kura \
			-Dkura.custom.configuration=file:${DIR}/kura/kura_custom.properties \
			-Dkura.data.dir=${DIR}/data \
			-jar ${DIR}/plugins/org.eclipse.osgi_3.8.1.v20120830-144521.jar \
			-configuration /tmp/.kura/configuration \
			-console 5002 \
			-consoleLog >> /var/log/kura-console.log 2>> /var/log/kura-console.log &amp;

			#Save the PID
			KURA_PID=$!
			echo $KURA_PID > /var/run/kura.pid
		</echo>

		<!-- Populate parameters -->
		<!-- 		
		<copy file="src/main/resources/${build.name}/kura_install.sh"
			tofile="${project.build.directory}/${build.output.name}/kura_install.sh" />
		<copy file="src/main/resources/${build.name}/recover_dflt_kura_config.sh"
			tofile="${project.build.directory}/${build.output.name}/recover_dflt_kura_config.sh" />
		<copy file="src/main/resources/common/kura.init.wrl"
			tofile="${project.build.directory}/${build.output.name}/kura.init.wrl"
			failonerror="false" />
		<copy file="src/main/resources/common/kura.init.yocto"
			tofile="${project.build.directory}/${build.output.name}/kura.init.yocto"
			failonerror="false" />
		<copy file="src/main/resources/common/kura.init.raspbian"
			tofile="${project.build.directory}/${build.output.name}/kura.init.raspbian"
			failonerror="false" />
		<replaceregexp
			file="${project.build.directory}/${build.output.name}/kura_install.sh"
			match="INSTALL_DIR=.*" replace="INSTALL_DIR=${kura.install.dir}" />
		<replaceregexp
			file="${project.build.directory}/${build.output.name}/recover_dflt_kura_config.sh"
			match="INSTALL_DIR=.*" replace="INSTALL_DIR=${kura.install.dir}" />
		<replaceregexp
			file="${project.build.directory}/${build.output.name}/kura.init.wrl"
			match="INSTALL_DIR=.*" replace="INSTALL_DIR=${kura.install.dir}" />
		<replaceregexp
			file="${project.build.directory}/${build.output.name}/kura.init.yocto"
			match="INSTALL_DIR=.*" replace="INSTALL_DIR=${kura.install.dir}" />
		<replaceregexp
			file="${project.build.directory}/${build.output.name}/kura.init.raspbian"
			match="INSTALL_DIR=.*" replace="INSTALL_DIR=${kura.install.dir}" />
		-->

		<zip destfile="${project.build.directory}/${build.output.name}.zip">

			<zipfileset
				file="${project.build.directory}/${build.output.name}/snapshot_0.xml"
				prefix="${build.output.name}/data/snapshots/" />

			<zipfileset
				file="${project.build.directory}/${build.output.name}/config.ini"
				prefix="${build.output.name}/kura/" />

			<zipfileset file="src/main/resources/common/kura_custom.properties"
				prefix="${build.output.name}/kura/" />

			<!-- <zipfileset file="${project.build.directory}/${build.output.name}/kura_install.sh" 
				prefix="${build.output.name}/install/" /> <zipfileset file="${project.build.directory}/${build.output.name}/recover_dflt_kura_config.sh" 
				prefix="${build.output.name}/install/" /> <zipfileset file="src/main/resources/${build.name}/kuranet.conf" 
				prefix="${build.output.name}/install/" /> <zipfileset file="${project.build.directory}/${build.output.name}/kura.init.wrl" 
				prefix="${build.output.name}/install" /> <zipfileset file="${project.build.directory}/${build.output.name}/kura.init.yocto" 
				prefix="${build.output.name}/install" /> <zipfileset file="${project.build.directory}/${build.output.name}/kura.init.raspbian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/${build.name}/firewall.init" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monit.init.wrl" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monit.init.yocto" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monit.init.raspbian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monitrc.wrl" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monitrc.yocto" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/monitrc.raspbian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/logrotate.conf" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/kura.logrotate" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/hostapd.conf" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/dhcpd-eth0.conf" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/dhcpd-wlan0.conf" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/named/named.conf" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/named/named.ca" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/named/named.rfc1912.zones" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/named/usr.sbin.named" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifcfg-eth0" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifcfg-eth1" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifcfg-wlan0" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/network.interfaces" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/network.interfaces.raspbian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifdown-local" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifup-local" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifup-local.debian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ifup-local.raspbian" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ip-down.local" 
				prefix="${build.output.name}/install" /> <zipfileset file="src/main/resources/common/ip-up.local" 
				prefix="${build.output.name}/install" /> -->
			<zipfileset
				file="${project.build.directory}/${build.output.name}/start_kura_background.sh"
				fullpath="${build.output.name}/bin/start_kura_background.sh"
				filemode="777" />

			<zipfileset file="RELEASE_NOTES.txt" prefix="${build.output.name}/kura/" />
			<zipfileset file="notice.html" prefix="${build.output.name}/" />
			<zipfileset file="epl-v10.html" prefix="${build.output.name}/" />
			<zipfileset file="src/main/resources/${build.name}/log4j.properties"
				prefix="${build.output.name}/kura/" />
			<zipfileset
				file="${project.build.directory}/${build.output.name}/kura.properties"
				prefix="${build.output.name}/kura/" />

			<zipfileset dir="${kura.osgi.repo}/plugins/" prefix="${build.output.name}/plugins" />
			<zipfileset dir="../target-definition/common/repository/plugins" prefix="${build.output.name}/plugins" />
			
            <zipfileset file="${project.build.directory}/${build.output.name}/jdk.dio.policy" prefix="${build.output.name}/kura/" />
        	<zipfileset file="${project.build.directory}/${build.output.name}/jdk.dio.properties" prefix="${build.output.name}/kura/" />

			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.deployment.agent_${org.eclipse.kura.deployment.agent.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.api_${org.eclipse.kura.api.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core_${org.eclipse.kura.core.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.cloud_${org.eclipse.kura.core.cloud.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.comm_${org.eclipse.kura.core.comm.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.configuration_${org.eclipse.kura.core.configuration.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.crypto_${org.eclipse.kura.core.crypto.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.deployment_${org.eclipse.kura.core.deployment.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.core.net_${org.eclipse.kura.core.net.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.emulator_${org.eclipse.kura.emulator.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
		</zip>
		<antcall target="web-jar" />
		<echo message="Building Kura Distribution for ${build.name}-jars..." />

	</target>

	<target name="web-config" if="web.jar.present">
		<propertyfile
			file="${project.build.directory}/${build.output.name}/config.ini">
			<entry key="osgi.bundles" operation="+"
				value=", reference:file:${kura.install.dir}/kura/kura/plugins/org.eclipse.kura.web_${org.eclipse.kura.web.version}.jar@4:start" />
		</propertyfile>
	</target>

	<target name="web-jar" if="web.jar.present">
		<zip destfile="${project.build.directory}/${build.output.name}.zip"
			update="true">
			<zipfileset
				file="${project.build.directory}/plugins/org.eclipse.kura.web_${org.eclipse.kura.web.version}.jar"
				prefix="${build.output.name}/kura/plugins" />
		</zip>
	</target>

</project>

